import base64
import json
# edicion
# --- LÓGICA DE LA APLICACIÓN (Seguro) ---
def _validar_perfil(perfil):
    """Validación simple del perfil. Lanzará ValueError si es inválido."""
    if not isinstance(perfil, dict):
        raise ValueError("Perfil debe ser un objeto JSON")

    required = {
        "username": str,
        "email": str,
    }

    optional = {
        "age": int,
    }

    for key, typ in required.items():
        if key not in perfil:
            raise ValueError(f"Falta el campo requerido: {key}")
        if not isinstance(perfil[key], typ):
            raise ValueError(f"Tipo inválido para {key}: se esperaba {typ.__name__}")

    for key, value in perfil.items():
        if key in optional:
            expected = optional[key]
            if not isinstance(value, expected):
                raise ValueError(f"Tipo inválido para {key}: se esperaba {expected.__name__}")
        elif key not in required:
            # Rechazamos propiedades adicionales para evitar datos inesperados
            raise ValueError(f"Propiedad no permitida en perfil: {key}")


def procesar_perfil_usuario(datos_base64):
    """Procesa un perfil recibido como base64(json).

    Esta función evita deserializadores inseguros como pickle y realiza validación
    explícita del esquema del perfil.
    """
    print("[Servidor] Recibiendo datos de perfil...")
    try:
        datos = base64.b64decode(datos_base64)
        perfil = json.loads(datos)
        _validar_perfil(perfil)
        print(f"[Servidor] Perfil procesado para: {perfil['username']}")
    except Exception as e:
        print(f"[Servidor] Error al procesar: {e}")


# --- DEMOSTRACIÓN SEGURA ---
if __name__ == "__main__":
    ejemplo_perfil = {
        "username": "victor",
        "email": "victor@example.com",
        "age": 30,
    }

    datos = json.dumps(ejemplo_perfil).encode()
    payload_final = base64.b64encode(datos).decode()

    print("--- Simulación de envío seguro de perfil (JSON + validación) ---")
    print(f"Payload generado (base64): {payload_final}\n")

    procesar_perfil_usuario(payload_final)
